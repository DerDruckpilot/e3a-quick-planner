<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E-3A AWACS quick planner</title>
 
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="E-3A Planner">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icon-180.png">
<link rel="icon" type="image/png" sizes="512x512" href="assets/icon-512.png">
 
 
  <style>
    :root{
      --bg:#ffffff; --fg:#111111; --muted:rgba(0,0,0,.65);
      --card:#ffffff; --border:#dddddd; --tab:#f2f2f2; --tabActive:#e6e6e6;
      --inputBg:#ffffff; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    body.dark{
      --bg:#000000; --fg:#ffffff; --muted:rgba(255,255,255,.70);
      --card:#0f0f0f; --border:#2a2a2a; --tab:#141414; --tabActive:#1f1f1f;
      --inputBg:#0f0f0f;
    }
    body{ margin:14px; background:var(--bg); color:var(--fg); }
 
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .header-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .awacs-logo{
      height:38px; width:auto; display:block; opacity:0.95;
    }
    h1{ margin:0; font-size:18px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
 
    .switch{ position:relative; width:52px; height:28px; flex:0 0 auto; }
    .switch input{ display:none; }
    .slider{ position:absolute; inset:0; background:var(--tab); border:1px solid var(--border); border-radius:999px; }
    .slider:before{
      content:""; position:absolute; width:22px; height:22px; top:2px; left:3px;
      background:var(--card); border:1px solid var(--border); border-radius:999px; transition:.2s;
    }
    .switch input:checked + .slider:before{ transform:translateX(24px); }
 
    .tabs{ display:flex; gap:8px; margin: 10px 0 12px; }
    .tabbtn{
      flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:var(--tab); color:var(--fg); font-size:16px;
    }
    .tabbtn.active{ background:var(--tabActive); font-weight:800; }
 
    .card{
      border:1px solid var(--border); background:var(--card);
      border-radius:14px; padding:12px; margin-bottom:12px;
    }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
    input, select{
      width:100%; padding:10px; border-radius:12px; border:1px solid var(--border);
      background:var(--inputBg); color:var(--fg); font-size:16px; box-sizing:border-box;
    }

    /* iOS time inputs can overflow inside flex/cards unless min-width is forced */
    input{ min-width:0; }
    .row > *{ min-width:0; }
    input[type="time"]{ width:100%; display:block; min-width:0; }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .chk{ display:flex; align-items:center; gap:10px; margin-top:10px; }
    .chk input{ width:auto; transform:scale(1.15); }
    .divider{ border-top:1px dashed rgba(127,127,127,.25); margin:10px 0; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    td{ padding:6px 0; border-bottom:1px solid rgba(127,127,127,.15); }
    td:last-child{ text-align:right; font-variant-numeric: tabular-nums; }
    .sub td:first-child{ padding-left:18px; opacity:0.85; }
    .kpi{ font-size:26px; font-weight:900; margin-top:6px; }
    .mono{ font-variant-numeric:tabular-nums; }
    .ok{ color:var(--ok); font-weight:900; }
    .bad{ color:var(--bad); font-weight:900; }
    .warn{ color:var(--warn); font-weight:900; }
    .btnrow{ display:flex; gap:10px; margin-top:10px; }
    button{
      flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:var(--tab); color:var(--fg); font-size:16px;
    }
    .disclaimer{ text-align:center; font-size:12px; color:var(--muted); margin:14px 0 4px; }
   .hidden{ display:none; }
 
    @media (max-width: 420px){
      .awacs-logo{ height:34px; }
      h1{ font-size:17px; }
    }
 
.launch{
  position:fixed; inset:0;
  background:#000;
  z-index:99999;
  display:flex; align-items:center; justify-content:center;
}
 
.launch-inner{
  position:relative;
  width:min(92vw, 520px);
  height:220px;
}
 
.reveal-wrap{
  position:absolute; left:0; right:0; top:60px;
  height:48px;
  overflow:hidden;
}
 
.reveal-text{
  font-weight:800;
  font-size:34px;
  letter-spacing:0.5px;
  color:#fff;
  text-align:left;
  padding-left:8px;
}
 
.reveal-mask{
  position:absolute; inset:0;
  background:#000;
  animation:reveal 1.8s ease forwards;
  transform:translateX(0);
}
 
/* AWACS flies right -> left */
.launch-awacs{
  position:absolute;
  width:min(75vw, 460px);
  height:auto;
  bottom:-120px;                 /* startet etwas tiefer */
  right:-90vw;                   /* startet außerhalb rechts */
  opacity:0;
  animation:flyIn 1.8s ease-out forwards;
  filter:drop-shadow(0 14px 30px rgba(0,0,0,.8));
}
 
 
 
@keyframes flyIn{
  0% {
    transform:translate(0, 0);
    opacity:0;
  }
  20% {
    opacity:1;
  }
  100% {
    transform:translate(-52vw, -60px);
    opacity:1;
  }
}
 
 
 
/* Mask slides away to reveal the text */
@keyframes reveal{
  0%   { transform:translateX(0); }
  100% { transform:translateX(110%); }
}
 
/* respects iOS reduce motion */
@media (prefers-reduced-motion: reduce){
  .launch-awacs, .reveal-mask{ animation:none !important; }
  .launch-awacs{ opacity:0; }
  .reveal-mask{ transform:translateX(110%); }
}
 
    /* Prevent iOS input overflow */
input, select, textarea {
  box-sizing: border-box;
  max-width: 100%;
}
 
/* Time inputs full width */
#totalTime, #orbitTime, #transTime, #aarTime {
  width: 100%;
  display: block;
} 
    
  

/* --- definitive iOS time input containment fix --- */

.card input[type="time"] {
  width: 100%;
  max-width: 100%;
  min-width: 0;
  box-sizing: border-box;
  display: block;
  padding-right: 0;
}

/* add visual right inset via inner spacing */
.card {
  padding-right: 22px;
}

.row > * {
  min-width: 0;
  flex: 1 1 0%;
}

input[type="time"]::-webkit-date-and-time-value {
  min-width: 0;
}

input[type="time"]::-webkit-calendar-picker-indicator {
  margin-left: auto;
}


.pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--tab);
  font-size:12px;
  opacity:0.85;
  white-space:nowrap;
}


    .prefixWrap{ display:flex; align-items:center; gap:8px; }
    .prefixFixed{ padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:var(--tab); font-weight:800; }
    .mutedSmall{ font-size:12px; color:var(--muted); margin-top:6px; }
    .planTable{ width:100%; border-collapse:collapse; table-layout:fixed; }
    .planTable th{ font-size:12px; color:var(--muted); font-weight:700; padding:6px 0; border-bottom:1px solid rgba(127,127,127,.15); }
    .planTable td{ padding:8px 0; border-bottom:1px solid rgba(127,127,127,.12); vertical-align:middle; }
    .planTable td input{ margin:0; }
    .timeZ{ text-align:right; }


    .btnSmall{ padding:8px 12px; border-radius:12px; border:1px solid var(--border); background:var(--tab); color:var(--fg); font-weight:800;  touch-action: manipulation;}
    .btnSmall.danger{ background:rgba(255,0,0,.08); }


    #viewMsn .planTable input[type="time"]{ width:100%; max-width:100%; min-width:0; box-sizing:border-box; }

    #viewMsn .planTable th:nth-child(1), #viewMsn .planTable td:nth-child(1){ width:30%; }
    #viewMsn .planTable th:nth-child(2), #viewMsn .planTable td:nth-child(2){ width:35%; }
    #viewMsn .planTable th:nth-child(3), #viewMsn .planTable td:nth-child(3){ width:35%; }
    #viewMsn .planTable td{ overflow:hidden; }
    #viewMsn .planTable input[type="time"]{ width:100%; max-width:100%; min-width:0; box-sizing:border-box; display:block; }


    .iconBtn{ border:1px solid var(--border); background:var(--tab); color:var(--fg); border-radius:12px; padding:8px 10px; font-size:18px; line-height:18px;  touch-action: manipulation;}
    .modal{ position:fixed; inset:0; z-index:9999; }
    .modalBackdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); z-index:0; }
    .modalSheet{ position:absolute; left:12px; right:12px; bottom:12px; z-index:1; background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,.5); }

</style>
</head>
 
<body>
 
<div id="launch" class="launch">
  <div class="launch-inner">
    <div class="reveal-wrap">
      <div class="reveal-text">E-3A Quick Planner</div>
      <div class="reveal-mask"></div>
    </div>
 
    <img class="launch-awacs" src="assets/awacs.png" alt="AWACS">
  </div>
</div>
 
 
  <div class="header">
    <div class="header-left">
      <img class="awacs-logo" src="./assets/awacs.png" alt="E-3A AWACS" />
      <h1>E-3A AWACS quick planner</h1>
    </div>
 
    <label class="switch" title="Light / Dark">
      <input id="themeToggle" type="checkbox" />
      <span class="slider"></span>
    </label>
  </div>
 
  <div class="tabs">
    <button id="tabFuel" class="tabbtn active">Fuel</button>
    <button id="tabWind" class="tabbtn">Wind</button>
    <button id="tabMsn" class="tabbtn">MSN Planning</button>
    <button id="tabChecklist" class="tabbtn">Checklist</button>
    <button id="tabSeat" class="tabbtn">Seat Flow</button>
  </div>
 
  <!-- FUEL TAB -->
  <div id="viewFuel">
    <div class="card">
      <label>Mode</label>
      <select id="fuelMode">
        <option value="time">Time → required ramp fuel</option>
        <option value="fuel">Ramp fuel → max flight time</option>
      </select>
 
      <div style="height:10px"></div>
 
      <label>Total flight time (hh:mm)</label>
      <input id="totalTime" type="time" step="60" value="01:30">
 
      <div style="height:10px"></div>
 
      <label>Ramp fuel (klbs) — used for max flight time mode</label>
      <input id="rampFuelIn" type="text"
       inputmode="decimal"
       pattern="[0-9]*[.,]?[0-9]*"
       autocomplete="off"
       autocorrect="off"
       spellcheck="false"
       placeholder="e.g. 110.0">
 
      <div class="divider"></div>
 
      <div class="row">
        <div>
          <label>Destination / FOB (diversion table)</label>
          <select id="dest"></select>
        </div>
        <div>
          <label>Alternate (DEST → ALT)</label>
          <select id="alt"></select>
        </div>
      </div>
 
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Diversion time</label>
          <input id="divTime">
        </div>
        <div>
          <label>Diversion fuel</label>
          <input id="divFuel">
        </div>
      </div>
    </div>
 
    <div class="card">
      <label>Orbit / holding time (hh:mm)</label>
      <input id="orbitTime" type="time" step="60" value="00:00">
 
      <label style="margin-top:10px;">Transition time (hh:mm)</label>
      <input id="transTime" type="time" step="60" value="00:00">
 
      <label style="margin-top:10px;">AAR time (hh:mm)</label>
      <input id="aarTime" type="time" step="60" value="00:00">
 
      <label style="margin-top:10px;">Received fuel from tanker (klbs)</label>
      <input id="aarRecv" type="text"
       inputmode="numeric"
       pattern="[0-9]*"
       autocomplete="off"
       autocorrect="off"
       spellcheck="false"
       placeholder="e.g. 12">
    </div>
 
    <div class="card">
      <div class="chk">
        <input id="tripContOn" type="checkbox">
        <label for="tripContOn" style="margin:0;color:var(--fg);font-size:14px;">Trip contingency 5%</label>
      </div>
<div class="chk">
        <input id="orbitContOn" type="checkbox">
        <label for="orbitContOn" style="margin:0;color:var(--fg);font-size:14px;">Orbit contingency 3%</label>
      </div>
<div class="divider"></div>
 
      <div class="kpi" id="fuelKPI">—</div>
 
      <table>
        <tbody>
          <tr><td>Taxi (fixed)</td><td class="mono" id="taxiOut">—</td></tr>
          <tr><td>Minimum overhead DEST (fixed)</td><td class="mono" id="minOverOut">—</td></tr>
          <tr><td>Diversion (DEST → ALT)</td><td class="mono" id="divFuelOut">—</td></tr>
 
          <tr><td><b>Trip fuel (computed)</b></td><td class="mono"><b id="tripFuelOut">—</b></td></tr>
 
          <tr class="sub"><td>Cruise</td><td class="mono" id="cruiseFuelOut">—</td></tr>
          <tr class="sub"><td>Orbit / holding (12/hr)</td><td class="mono" id="orbitFuelOut">—</td></tr>
          <tr class="sub"><td>Transition (15/hr)</td><td class="mono" id="transFuelOut">—</td></tr>
          <tr class="sub"><td>AAR (16/hr)</td><td class="mono" id="aarFuelOut">—</td></tr>
          <tr class="sub"><td>Trip contingency 5%</td><td class="mono" id="tripContOut">—</td></tr>
          <tr class="sub"><td>Orbit contingency 3%</td><td class="mono" id="orbitContOut">—</td></tr>
          <tr class="sub"><td>Received from tanker</td><td class="mono" id="recvOut">—</td></tr>
 
          <tr><td><b>Required ramp fuel</b></td><td class="mono"><b id="reqRampOut">—</b></td></tr>
          <tr><td>Margin vs entered ramp fuel</td><td class="mono" id="marginOut">—</td></tr>
          <tr><td><b>Max flight time (from ramp fuel input)</b></td><td class="mono"><b id="maxTimeOut">—</b></td></tr>
        </tbody>
      </table>
 
      <div class="btnrow">
        <button id="copyFuelBtn">Copy fuel summary</button>
        <button id="resetFuelBtn">Reset</button>
      </div>
    </div>
 
    <div class="disclaimer">for reference only</div>
  </div>
 
  <!-- WIND TAB -->
  <div id="viewWind" class="hidden">
    <div class="card">
      <label>Runway (e.g. 27, 09, 36)</label>
      <input id="rwy" type="text" value="27" inputmode="numeric" placeholder="27">
 
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Operation</label>
          <select id="op">
            <option value="TAKEOFF">Takeoff</option>
            <option value="LANDING" selected>Landing</option>
            <option value="TNG_DRY">Touch &amp; Go (Dry)</option>
            <option value="TNG_WET">Touch &amp; Go (Wet)</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <div class="chk" style="margin:0;">
            <input id="firstPilot" type="checkbox">
            <label for="firstPilot" style="margin:0;color:var(--fg);font-size:14px;">First pilot (LDG XW limit 15 kt)</label>
          </div>
        </div>
      </div>
 
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Wind direction (°)</label>
          <input id="windDir" type="text" inputmode="numeric" min="0" max="360" step="1" value="270">
        </div>
        <div>
          <label>Wind speed (kt)</label>
          <input id="windSpd" type="text" inputmode="numeric" min="0" step="1" value="15">
        </div>
      </div>
 
      <label style="margin-top:10px;">Gust (kt) — optional</label>
      <input id="windGust" type="text" inputmode="numeric" min="0" step="1" placeholder="e.g. 25">
    </div>
 
    <div class="card">
      <div class="kpi" id="windStatus">—</div>
 
      <table>
        <tbody>
          <tr><td>Runway heading</td><td class="mono" id="rwyHdgOut">—</td></tr>
          <tr><td>Angle (Δ)</td><td class="mono" id="deltaOut">—</td></tr>
 
          <tr><td>Head/Tailwind</td><td class="mono" id="htOut">—</td></tr>
          <tr><td>Crosswind</td><td class="mono" id="xwOut">—</td></tr>
 
          <tr><td>Active limits</td><td class="mono" id="limitsOut">—</td></tr>
          <tr><td>Margin to nearest limit</td><td class="mono" id="marginWindOut">—</td></tr>
        </tbody>
      </table>
 
      <div class="divider"></div>
 
      <label>Quick reference (steady only)</label>
      <table>
        <tbody>
          <tr><td id="qrA_lbl">—</td><td class="mono" id="qrA">—</td></tr>
          <tr><td id="qrB_lbl">—</td><td class="mono" id="qrB">—</td></tr>
        </tbody>
      </table>
 
      <div class="btnrow">
        <button id="copyWindBtn">Copy wind summary</button>
        <button id="resetWindBtn">Reset</button>
      </div>
    </div>
 
    <div class="disclaimer">for reference only</div>
  </div>
 

  <!-- MSN PLANNING TAB -->
  <div id="viewMsn" class="hidden">
    <div class="card">
      <div class="row">
        <div>
          <label>MSN #</label>
          <input id="msn_msn" type="text" autocomplete="off" autocapitalize="characters" spellcheck="false">
        </div>
        <div>
          <label>Callsign</label>
          <input id="msn_callsign" type="text" autocomplete="off" spellcheck="false" value="NATO">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Tail</label>
          <input id="msn_tail" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <label>POB</label>
          <input id="msn_pob" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Spare</label>
          <input id="msn_spare" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <label>Orbit</label>
          <input id="msn_orbit" type="text" autocomplete="off" spellcheck="false">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Parking</label>
          <input id="msn_parking" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <label>Status</label>
          <input id="msn_status" type="text" autocomplete="off" spellcheck="false">
        </div>
      </div>

      <label style="margin-top:10px;">Alternate</label>
      <select id="msn_altSel"></select>
      <div id="msn_altOtherWrap" class="hidden" style="margin-top:10px;">
        <label>Alternate (other)</label>
        <input id="msn_altOther" type="text" autocomplete="off" spellcheck="false" placeholder="e.g. EDDK">
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div>
          <label style="margin-bottom:6px;">Timeline</label>
          <div class="chk" style="margin:0;">
            <input id="msn_deice" type="checkbox">
            <label for="msn_deice" style="margin:0;color:var(--fg);font-size:14px;">DE-ICE</label>
          </div>
        </div>
        <div></div>
      </div>

      <table class="planTable">
        <thead>
          <tr>
            <th style="text-align:left;">Event</th>
            <th style="text-align:center;">Local</th>
            <th style="text-align:right;">Zulu</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><b>TAKEOFF</b></td><td class="mono" id="msn_loc_to">—</td><td><input id="msn_z_to" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>SHOW</td><td class="mono" id="msn_loc_show">—</td><td><input id="msn_z_show" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>BUS 1</td><td class="mono" id="msn_loc_bus1">—</td><td><input id="msn_z_bus1" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>BUS 2</td><td class="mono" id="msn_loc_bus2">—</td><td><input id="msn_z_bus2" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>B4 START</td><td class="mono" id="msn_loc_b4">—</td><td><input id="msn_z_b4" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>DOOR CLOSE</td><td class="mono" id="msn_loc_door">—</td><td><input id="msn_z_door" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>ENG START</td><td class="mono" id="msn_loc_eng">—</td><td><input id="msn_z_eng" class="timeZ" type="time" step="60"></td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <table class="planTable">
        <thead>
          <tr>
            <th style="text-align:left;">Event</th>
            <th style="text-align:center;">Planned (Z)</th>
            <th style="text-align:center;">Actual (Z)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>T/O</td><td><input id="msn_p_to" class="timeZ" type="time" step="60"></td><td><input id="msn_a_to" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>LAND</td><td><input id="msn_p_land" class="timeZ" type="time" step="60"></td><td><input id="msn_a_land" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>ON/S</td><td><input id="msn_p_ons" class="timeZ" type="time" step="60"></td><td><input id="msn_a_ons" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>OFF/S</td><td><input id="msn_p_offs" class="timeZ" type="time" step="60"></td><td><input id="msn_a_offs" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>AR START</td><td><input id="msn_p_arst" class="timeZ" type="time" step="60"></td><td><input id="msn_a_arst" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>AR END</td><td><input id="msn_p_arend" class="timeZ" type="time" step="60"></td><td><input id="msn_a_arend" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>TX START</td><td><input id="msn_p_txst" class="timeZ" type="time" step="60"></td><td><input id="msn_a_txst" class="timeZ" type="time" step="60"></td></tr>
          <tr><td>TX END</td><td><input id="msn_p_txend" class="timeZ" type="time" step="60"></td><td><input id="msn_a_txend" class="timeZ" type="time" step="60"></td></tr>
        </tbody>
      </table>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>Dur (T/O actual → LAND actual) [hrs]</label>
          <input id="msn_dur" type="text" readonly>
        </div>
        <div>
          <label>T/O Fuel (klbs)</label>
          <input id="msn_fuel_to" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" autocomplete="off" spellcheck="false" placeholder="e.g. 110.0">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>END AAR Fuel (klbs)</label>
          <input id="msn_fuel_endaar" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" autocomplete="off" spellcheck="false" placeholder="e.g. 95.5">
        </div>
        <div>
          <label>LAND Fuel (klbs)</label>
          <input id="msn_fuel_land" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" autocomplete="off" spellcheck="false" placeholder="e.g. 60.2">
        </div>
      </div>
    </div>

    
    
<div class="card">
      <label>AAR Info</label>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Tanker Tail</label>
          <input id="msn_tanker_tail" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <label>Unit</label>
          <input id="msn_tanker_unit" type="text" autocomplete="off" spellcheck="false">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Offload (klbs)</label>
          <input id="msn_tanker_offload" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <label>&nbsp;</label>
          <input type="text" value="" style="visibility:hidden;">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>END AR WT (klbs)</label>
          <input id="msn_tanker_end_wt" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" autocomplete="off" spellcheck="false">
        </div>
        <div>
          <label>END AR RQST (klbs)</label>
          <input id="msn_tanker_end_rqst" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" autocomplete="off" spellcheck="false">
        </div>
      </div>
    </div>



    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <label style="margin:0;">Quick Reference</label>
        <button id="qrSettingsBtn" type="button" class="iconBtn" aria-label="Settings">⚙️</button>
      </div>

      <div class="mutedSmall" style="margin-top:6px;">Email morning of flight</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Orders / CMD Post</label>
          <input id="qr_email_orders" type="email" readonly data-persist="settings" value="dummy@naew.nato.int">
        </div>
        <div>
          <label>ORM / Safety</label>
          <input id="qr_email_orm" type="email" readonly data-persist="settings" value="dummy@naew.nato.int">
        </div>
      </div>

      <div class="divider"></div>

      <table class="planTable" style="border-bottom:0;">
        <tbody>
          <tr><td style="font-weight:900;">WX</td><td style="text-align:right;" class="mono">x6190</td></tr>
          <tr><td style="font-weight:900;">AIS</td><td style="text-align:right;" class="mono">x6131/6132</td></tr>
          <tr><td style="font-weight:900;">TKR</td><td style="text-align:right;" class="mono">x4372</td></tr>
          <tr><td style="font-weight:900;">CP</td><td style="text-align:right;" class="mono">x5555</td></tr>
          <tr><td style="font-weight:900;">SHORT RANGE</td><td style="text-align:right;" class="mono">x4415</td></tr>
        </tbody>
      </table>
    </div>

    </div>

    
      <div class="row" style="margin-top:14px;">
        <button id="msnExport" class="btnSmall">Export MSN</button>
        <button id="msnReset" class="btnSmall danger">Reset MSN</button>
      </div>

    <div class="disclaimer">stored locally on this device</div>
  </div>

  <!-- CHECKLIST TAB -->
  <div id="viewChecklist" class="hidden">
    <div class="card">
      <div id="checklistContainer"></div>
      <div class="btnrow">
        <button id="resetChecklistBtn">Reset checklist</button>
      </div>
    </div>
    <div class="disclaimer">for reference only</div>
  </div>

  <!-- SEAT FLOW TAB -->
  <div id="viewSeat" class="hidden">
    <div class="card">
      <label>Seat Flow</label>
      <table>
        <thead>
          <tr>
            <td><b>Phase</b></td>
            <td><b>Left</b></td>
            <td><b>Right</b></td>
            <td><b>Seat 5</b></td>
            <td style="text-align:right;"><b>Time</b></td>
          </tr>
        </thead>
        <tbody id="seatTableBody"></tbody>
      </table>
      <div class="btnrow">
        <button id="addSeatRowBtn">Add row</button>
        <button id="resetSeatBtn">Reset</button>
      </div>
    </div>
    <div class="disclaimer">for reference only</div>
  </div>

<script>
(() => {
  const BUILD_VERSION = "2026-02-17 12:20:35 UTC (4634)";
  const $ = (id) => document.getElementById(id);
 
  // THEME
  const savedTheme = localStorage.getItem("e3a_theme");
  if (savedTheme === "dark") { document.body.classList.add("dark"); $("themeToggle").checked = true; }
  $("themeToggle").addEventListener("change", () => {
    document.body.classList.toggle("dark", $("themeToggle").checked);
    localStorage.setItem("e3a_theme", $("themeToggle").checked ? "dark" : "light");
  });
 
  // TABS
  function setTab(tab){
    const tabs = ["fuel","wind","msn","checklist","seat"];
    tabs.forEach(t => {
      const btn = $("tab" + (t==="fuel"?"Fuel":t==="wind"?"Wind":t==="msn"?"Msn":t==="checklist"?"Checklist":"Seat"));
      const view = $("view" + (t==="fuel"?"Fuel":t==="wind"?"Wind":t==="msn"?"Msn":t==="checklist"?"Checklist":"Seat"));
      btn.classList.toggle("active", t===tab);
      view.classList.toggle("hidden", t!==tab);
    });
  }
  $("tabFuel").addEventListener("click", () => setTab("fuel"));
  $("tabWind").addEventListener("click", () => setTab("wind"));
  $("tabMsn").addEventListener("click", () => setTab("msn"));
  $("tabChecklist").addEventListener("click", () => setTab("checklist"));
  $("tabSeat").addEventListener("click", () => setTab("seat"));
const STORAGE_KEY = "e3a_planner_state_v1";
  const CHECKLIST_ITEMS = [{"section": "MISSION PLANNING", "text": "APS Mission Overview", "tag": ""}, {"section": "MISSION PLANNING", "text": "WX Forecast", "tag": ""}, {"section": "MISSION PLANNING", "text": "Fuel Timeline", "tag": ""}, {"section": "MISSION PLANNING", "text": "Call WX (x6190)", "tag": ""}, {"section": "MISSION PLANNING", "text": "Run TOLD w/ FE", "tag": ""}, {"section": "MISSION PLANNING", "text": "Joker & Bingo Fuel", "tag": ""}, {"section": "MISSION PLANNING", "text": "Dip Clearances (OWES)", "tag": ""}, {"section": "MISSION PLANNING", "text": "Flight Plan Request (SWAAI x6130/6131)", "tag": ""}, {"section": "MISSION PLANNING", "text": "Notification of Overflight (NOF) (OWES)", "tag": ""}, {"section": "MISSION PLANNING", "text": "NOTAMS", "tag": ""}, {"section": "MISSION PLANNING", "text": "CFPS", "tag": ""}, {"section": "MISSION PLANNING", "text": "Email MP Slides to TD", "tag": ""}, {"section": "MISSION PLANNING", "text": "Approach Request to CMD Post", "tag": ""}, {"section": "MISSION PLANNING", "text": "Change Request (OWES), NLT 1400", "tag": ""}, {"section": "MISSION PLANNING", "text": "ORM", "tag": ""}, {"section": "MISSION PLANNING", "text": "Flight Orders", "tag": ""}, {"section": "MISSION PLANNING", "text": "Ops Brief", "tag": ""}, {"section": "MISSION PLANNING", "text": "Msn Pln'g Summary Report, NLT 1530", "tag": ""}, {"section": "MISSION PLANNING", "text": "Seat Flow / REVIEW STUD FOLDERS", "tag": ""}, {"section": "MISSION PLANNING", "text": "Cut Card", "tag": ""}, {"section": "MISSION PLANNING", "text": "Print CFPS Flight Log", "tag": ""}, {"section": "MISSION PLANNING", "text": "CRD in \"Missions\" Folder", "tag": ""}, {"section": "MISSION PLANNING", "text": "Message Pilots/FE Details/Assignments", "tag": ""}, {"section": "FLY DAY", "text": "Mission Binder", "tag": ""}, {"section": "FLY DAY", "text": "M2 (if no MSN Crew)", "tag": ""}, {"section": "FLY DAY", "text": "Login to Brief", "tag": ""}, {"section": "FLY DAY", "text": "Check/Sign Flt Orders", "tag": ""}, {"section": "FLY DAY", "text": "Email Orders/ORM", "tag": ""}, {"section": "FLY DAY", "text": "3x Copies of Flt Orders", "tag": ""}, {"section": "FLY DAY", "text": "AIS", "tag": ""}, {"section": "FLY DAY", "text": "Flt Plan → Foreflight", "tag": ""}];

  function loadState(){
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}") || {};
    } catch(_) { return {}; }
  }
  function saveState(state){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(_) {}
  }
  function getState(){
    const s = loadState();
    s.inputs = s.inputs || {};
    s.checklist = s.checklist || {};
    s.seat = s.seat || [];
    return s;
  }
  
  function exportMsnState(){
    const data = {};
    document.querySelectorAll("#viewMsn input, #viewMsn select, #viewMsn textarea").forEach(el => {
      if (!el.id) return;
      if (el.type === "checkbox") data[el.id] = !!el.checked;
      else data[el.id] = el.value;
    });
    const payload = JSON.stringify({ msn: data }, null, 2);
    const blob = new Blob([payload], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "msn_planning.json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function resetMsnState(){
    if(!confirm("Reset MSN Planning data on this device?")) return;
    // Clear UI
    document.querySelectorAll("#viewMsn input, #viewMsn select, #viewMsn textarea").forEach(el => {
      if (!el.id) return;
      if (el.dataset && el.dataset.persist === "settings") return;
      if (el.type === "checkbox") el.checked = false;
      else if (el.tagName === "SELECT") el.selectedIndex = 0;
      else el.value = "";
    });
    // Remove saved keys
    const state = getState();
    Object.keys(state.inputs).forEach(k => {
      if (k.startsWith("msn_")) delete state.inputs[k];
    });
    saveState(state);
    // Re-run timeline calc if available
    if (typeof updateTimeline === "function") updateTimeline();
    if (typeof updateDur === "function") updateDur();
  }


  function applySavedInputs(){
    const state = getState();
    Object.entries(state.inputs).forEach(([id,val]) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === "checkbox") el.checked = !!val;
      else el.value = val;
    });
  }

  function persistInput(id){
    const el = document.getElementById(id);
    if (!el) return;
    const state = getState();
    state.inputs[id] = (el.type === "checkbox") ? !!el.checked : el.value;
    saveState(state);
  }

  function wireAutoSave(ids){
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const evt = (el.type === "checkbox") ? "change" : "input";
      el.addEventListener(evt, () => persistInput(id));
    });
  }

  function renderChecklist(){
    const state = getState();
    const root = $("checklistContainer");
    if (!root) return;
    root.innerHTML = "";
    let current = "";
    CHECKLIST_ITEMS.forEach((it, idx) => {
      if (it.section !== current) {
        current = it.section;
        const h = document.createElement("div");
        h.style.fontWeight = "700";
        h.style.margin = "10px 0 6px";
        h.textContent = current;
        root.appendChild(h);
      }
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.gap = "10px";
      row.style.padding = "6px 0";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      const key = "chk_" + idx;
      cb.checked = !!state.checklist[key];
      cb.addEventListener("change", () => {
        const s = getState();
        s.checklist[key] = !!cb.checked;
        saveState(s);
      });
      const txt = document.createElement("div");
      txt.style.flex = "1 1 auto";
      txt.textContent = it.text;
      row.appendChild(cb);
      row.appendChild(txt);
      if (it.tag) {
        const tag = document.createElement("div");
        tag.className = "pill";
        tag.textContent = it.tag;
        row.appendChild(tag);
      }
      root.appendChild(row);
    });
  }

  function seatRowEl(row){
    const tr = document.createElement("tr");

    function cell(key, placeholder, type="text"){
      const td = document.createElement("td");
      const inp = document.createElement("input");
      inp.type = type;
      if (type === "time") inp.step = "60";
      inp.placeholder = placeholder;
      inp.value = row[key] || "";
      inp.addEventListener("input", persistSeat);
      td.appendChild(inp);
      return [td, inp];
    }

    const [tdPhase, iPhase] = cell("phase", "Phase");
    const [tdLeft, iLeft] = cell("left", "Left");
    const [tdRight, iRight] = cell("right", "Right");
    const [tdSeat5, iSeat5] = cell("seat5", "Seat 5");
    const [tdTime, iTime] = cell("time", "Time", "time");
    tdTime.style.textAlign = "right";

    const tdDel = document.createElement("td");
    tdDel.style.textAlign = "right";
    const del = document.createElement("button");
    del.textContent = "✕";
    del.style.padding = "6px 10px";
    del.addEventListener("click", (e) => {
      e.preventDefault();
      tr.remove();
      persistSeat();
    });
    tdDel.appendChild(del);

    tr.appendChild(tdPhase);
    tr.appendChild(tdLeft);
    tr.appendChild(tdRight);
    tr.appendChild(tdSeat5);
    tr.appendChild(tdTime);
    tr.appendChild(tdDel);

    tr._inputs = { iPhase, iLeft, iRight, iSeat5, iTime };
    return tr;
  }

  function readSeatTable(){
    const rows = Array.from($("seatTableBody").querySelectorAll("tr"));
    return rows.map(tr => {
      const i = tr._inputs;
      return {
        phase: i.iPhase.value,
        left: i.iLeft.value,
        right: i.iRight.value,
        seat5: i.iSeat5.value,
        time: i.iTime.value
      };
    });
  }

  function persistSeat(){
    const state = getState();
    state.seat = readSeatTable();
    saveState(state);
  }

  function renderSeat(){
    const state = getState();
    const body = $("seatTableBody");
    if (!body) return;
    body.innerHTML = "";
    const rows = (state.seat && state.seat.length) ? state.seat : [{},{},{},{},{}];
    rows.forEach(r => {
      const tr = seatRowEl({
        phase: r.phase || "",
        left: r.left || "",
        right: r.right || "",
        seat5: r.seat5 || "",
        time: r.time || ""
      });
      body.appendChild(tr);
    });
  }

  function resetChecklist(){
    const s = getState();
    s.checklist = {};
    saveState(s);
    renderChecklist();
  }

  function resetSeat(){
    const s = getState();
    s.seat = [];
    saveState(s);
    renderSeat();
  }

  function resetMsn(){
    const ids = ["msn_msn","msn_callsign","msn_tail","msn_pob","msn_orbit","msn_parking","msn_status","msn_spare","msn_alternate",
      "msn_show","msn_bus1","msn_bus2","msn_b4start","msn_doorclose","msn_engstart","msn_deice","msn_takeoff","msn_to","msn_land","msn_ons","msn_offs","msn_arstart","msn_arend","msn_txstart","msn_txend",
      "msn_orders_email","msn_orm_email"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    const s = getState();
    ids.forEach(id => delete s.inputs[id]);
    saveState(s);
  }
 
  // HELPERS
 
function parseHHMM(s){
    if (!s) return NaN;
    const t = String(s).trim();
    const m = t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/);
    if (!m) return NaN;
    const hh = Number(m[1]), mm = Number(m[2]);
    if (!isFinite(hh) || !isFinite(mm) || mm < 0 || mm >= 60 || hh < 0) return NaN;
    return hh + mm/60.0;
  }
  function hhmmFromHours(h){
    if (!isFinite(h) || h < 0) return "—";
    const totalMin = Math.max(0, Math.round(h * 60));
    const hh = Math.floor(totalMin / 60);
    const mm = totalMin % 60;
    return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
  }
  function fmt1(x){ return isFinite(x) ? x.toFixed(1) : "—"; }
  function setHTML(id, html){ $(id).innerHTML = html; }
  function setText(id, txt){ $(id).textContent = txt; }
  function num(id){
  const raw = ($(id).value || "").trim();
  const normalized = raw.replace(",", ".");
  const n = parseFloat(normalized);
  return isFinite(n) ? n : 0;
}
 
 
  // =========================
  // FUEL (unchanged)
  // =========================
  const TAXI = 1.8;
  const MIN_OVERHEAD_DEST = 14.0;
 
  const TABLES = {
    "MOB Geilenkirchen": [
      { alt:"Norvenich (ETNN)", time:"0:06", fuel:1.0 },
      { alt:"Eindhoven (EHEH)", time:"0:10", fuel:1.8 },
      { alt:"Köln/Bonn (EDDK)", time:"0:10", fuel:2.4 },
      { alt:"Brussels (EBBR)", time:"0:17", fuel:2.9 },
      { alt:"Spangdahlem (ETAD)", time:"0:18", fuel:3.7 },
      { alt:"Ramstein (ETAR)", time:"0:29", fuel:7.1 },
      { alt:"Mildenhall (EGUN)", time:"0:40", fuel:10.5 },
      { alt:"Waddington (EGXW)", time:"0:45", fuel:11.2 },
      { alt:"Karup (EKKA)", time:"0:52", fuel:13.0 },
    ],
    "FOB Konya": [
      { alt:"Afyon (LTAH)", time:"0:19", fuel:6.4 },
      { alt:"Antalya (LTAI)", time:"0:21", fuel:6.8 },
      { alt:"Esenboga (LTAC)", time:"0:23", fuel:7.0 },
      { alt:"Incirlik (LTAG)", time:"0:28", fuel:8.2 },
      { alt:"Cigli (LTBL)", time:"0:43", fuel:11.0 },
      { alt:"Diyarbakir (LTCC)", time:"1:01", fuel:14.2 },
    ],
    "FOB Aktion": [
      { alt:"Andravida (LGAD)", time:"0:10", fuel:3.6 },
      { alt:"Araxos (LGRX)", time:"0:19", fuel:4.4 },
      { alt:"Larissa (LGLR)", time:"0:27", fuel:4.4 },
      { alt:"Thessaloniki (LGTS)", time:"0:25", fuel:7.3 },
      { alt:"Souda Bay (LGSA)", time:"0:41", fuel:10.6 },
      { alt:"Trapani (LICT)", time:"0:58", fuel:14.5 },
    ],
    "FOL Oerland": [
      { alt:"Trondheim/Vaernes (ENVA)", time:"0:13", fuel:2.4 },
      { alt:"Gardermoen (ENGM)", time:"0:33", fuel:9.0 },
      { alt:"Rygge (ENRY)", time:"0:42", fuel:11.0 },
      { alt:"Bergen (ENBR)", time:"0:38", fuel:9.5 },
      { alt:"Bodo (ENBO)", time:"0:39", fuel:9.6 },
      { alt:"Torp (ENTO)", time:"0:44", fuel:11.0 },
      { alt:"Andoya (ENAN)", time:"0:56", fuel:13.9 },
      { alt:"Stavanger/Sola (ENZV)", time:"0:51", fuel:12.0 },
      { alt:"Evenes (ENEV)", time:"0:53", fuel:12.6 },
    ],
    "RAF Waddington": [
      { alt:"Mildenhall (EGUN)", time:"0:15", fuel:3.5 },
      { alt:"Brize Norton (EGVN)", time:"0:17", fuel:5.0 },
      { alt:"Leuchars (EGQL)", time:"0:33", fuel:8.2 },
      { alt:"Lossiemouth (EGQS)", time:"0:45", fuel:11.5 },
      { alt:"Keflavik (BIKF)", time:"2:45", fuel:35.3 },
    ],
    "FOB Trapani": [
      { alt:"Sigonella (LICZ)", time:"0:22", fuel:7.0 },
      { alt:"Decimomannu (LIED)", time:"0:29", fuel:8.0 },
      { alt:"Gioia del Colle (LIBV)", time:"0:46", fuel:11.5 },
      { alt:"Brindisi-Casale (LIBR)", time:"0:55", fuel:14.0 },
      { alt:"Pisa (LIRP)", time:"0:56", fuel:14.5 },
      { alt:"Aktion (LGPZ)", time:"1:02", fuel:15.2 },
      { alt:"Aviano (LIPA)", time:"1:18", fuel:18.2 },
    ],
    "Keflavik International": [
      { alt:"Lossiemouth (EGQS)", time:"1:54", fuel:25.0 },
      { alt:"Leuchars (EGQL)", time:"2:09", fuel:28.0 },
      { alt:"Oerland (ENOL)", time:"2:10", fuel:28.8 },
      { alt:"Stavanger (ENZV)", time:"2:12", fuel:29.0 },
      { alt:"Waddington (EGXW)", time:"2:41", fuel:35.2 },
    ],
  };
 
  function populateDest(){
    $("dest").innerHTML = "";
    Object.keys(TABLES).forEach(k => {
      const o = document.createElement("option");
      o.value = k; o.textContent = k;
      $("dest").appendChild(o);
    });
  }
  function populateAlt(){
    const d = $("dest").value;
    $("alt").innerHTML = "";
    TABLES[d].forEach((r, idx) => {
      const o = document.createElement("option");
      o.value = String(idx);
      o.textContent = r.alt;
      $("alt").appendChild(o);
    });
  }
  function setDivFields(){
    const d = $("dest").value;
    const idx = Number($("alt").value || 0);
    const r = TABLES[d][idx];
    $("divTime").value = r.time;
    $("divFuel").value = fmt1(r.fuel) + " klbs";
  }
 
  function calcFuel(){
    const mode = $("fuelMode").value;
 
   const totalH = parseHHMM($("totalTime").value);
    const orbitH_in = Math.max(0, parseHHMM($("orbitTime").value) || 0);
    const transH_in = Math.max(0, parseHHMM($("transTime").value) || 0);
    const aarH_in   = Math.max(0, parseHHMM($("aarTime").value) || 0);
    const recvRaw = $("aarRecv").value || "";
    const recv = Math.max(0, Math.round(Number(String(recvRaw).replace(",", ".")) || 0));
    $("aarRecv").value = String(recv);
 
    const d = $("dest").value;
    const idx = Number($("alt").value || 0);
    const divertFuel = TABLES[d][idx].fuel;
 
    if (!isFinite(totalH) || totalH < 0) { $("fuelKPI").textContent = "—"; return; }
 
    const firstH = Math.min(2.0, totalH);
    const postH  = Math.max(0.0, totalH - 2.0);
 
    let orbitH = 0, transH = 0, aarH = 0;
    if (postH > 0) {
      const sum = orbitH_in + transH_in + aarH_in;
      if (sum > postH && sum > 0) {
        const sf = postH / sum;
        orbitH = orbitH_in * sf;
        transH = transH_in * sf;
        aarH   = aarH_in   * sf;
      } else {
        orbitH = orbitH_in; transH = transH_in; aarH = aarH_in;
      }
    }
 
    const specialSum = orbitH + transH + aarH;
    const cruisePostH = Math.max(0.0, postH - specialSum);
 
    const cruiseFuel = (firstH * 20.0) + (cruisePostH * 12.0);
    const orbitFuel  = orbitH * 12.0;
    const transFuel  = transH * 15.0;
    const aarFuel    = aarH   * 16.0;
 
    const tripCont = $("tripContOn").checked ? ((cruiseFuel + orbitFuel + transFuel + aarFuel) * 0.05) : 0.0;
    const orbitCont = $("orbitContOn").checked ? (orbitFuel * 0.03) : 0.0;
 
    const tripComputed = cruiseFuel + orbitFuel + transFuel + aarFuel + tripCont + orbitCont - recv;
    const reqRamp = TAXI + MIN_OVERHEAD_DEST + divertFuel + tripComputed;
 
    $("taxiOut").textContent = fmt1(TAXI) + " klbs";
    $("minOverOut").textContent = fmt1(MIN_OVERHEAD_DEST) + " klbs";
    $("divFuelOut").textContent = fmt1(divertFuel) + " klbs";
 
    $("tripFuelOut").textContent = fmt1(tripComputed) + " klbs";
    $("cruiseFuelOut").textContent = fmt1(cruiseFuel) + " klbs";
    $("orbitFuelOut").textContent = fmt1(orbitFuel) + " klbs";
    $("transFuelOut").textContent = fmt1(transFuel) + " klbs";
    $("aarFuelOut").textContent = fmt1(aarFuel) + " klbs";
    $("tripContOut").textContent = fmt1(tripCont) + " klbs";
    $("orbitContOut").textContent = fmt1(orbitCont) + " klbs";
    $("recvOut").textContent = "-" + fmt1(recv) + " klbs";
 
    $("reqRampOut").textContent = fmt1(reqRamp) + " klbs";
 
    const rampIn = num("rampFuelIn");
    if (isFinite(rampIn) && $("rampFuelIn").value.trim() !== "") {
      const margin = rampIn - reqRamp;
      $("marginOut").innerHTML = `<span class="${margin >= 0 ? "ok" : "bad"}">${fmt1(margin)} klbs</span>`;
    } else {
      $("marginOut").textContent = "—";
    }
 
    let maxTime = "—";
    if (isFinite(rampIn) && $("rampFuelIn").value.trim() !== "") {
      const fixed = TAXI + MIN_OVERHEAD_DEST + divertFuel;
      const availableTrip = rampIn - fixed;
 
      if (availableTrip <= 0) {
        maxTime = "00:00";
      } else {
        let bestMin = 0;
        for (let m = 0; m <= 20*60; m++) {
          const tH = m/60;
          const first = Math.min(2.0, tH);
          const post = Math.max(0.0, tH - 2.0);
 
          let oH=0,tHh=0,aH=0;
          if (post > 0) {
            const sum = orbitH_in + transH_in + aarH_in;
            if (sum > post && sum > 0) {
              const sf = post / sum;
              oH = orbitH_in*sf; tHh = transH_in*sf; aH = aarH_in*sf;
            } else {
              oH = orbitH_in; tHh = transH_in; aH = aarH_in;
            }
          }
          const special = oH + tHh + aH;
          const cruisePost = Math.max(0.0, post - special);
 
          const cFuel = (first*20.0) + (cruisePost*12.0);
          const oFuel = oH*12.0;
          const trFuel = tHh*15.0;
          const aaFuel = aH*16.0;
 
          const tc = $("tripContOn").checked ? ((cFuel+oFuel+trFuel+aaFuel)*0.05) : 0;
          const oc = $("orbitContOn").checked ? (oFuel*0.03) : 0;
 
          const tripComp = cFuel+oFuel+trFuel+aaFuel+tc+oc - recv;
 
          if (tripComp <= availableTrip + 1e-9) bestMin = m;
          else break;
        }
        maxTime = hhmmFromHours(bestMin/60);
      }
    }
    $("maxTimeOut").textContent = maxTime;
 
    $("fuelKPI").textContent =
      (mode === "time")
        ? (fmt1(reqRamp) + " klbs required ramp")
        : ("Max flight time: " + maxTime);
  }
 
  async function copyFuel(){
    const d = $("dest").value;
    const idx = Number($("alt").value || 0);
    const alt = TABLES[d][idx].alt;
 
    const text =
`E-3A Fuel (klbs)
Mode: ${$("fuelMode").selectedOptions[0].textContent}
 
Total time: ${$("totalTime").value}
Orbit: ${$("orbitTime").value}
Transition: ${$("transTime").value}
AAR: ${$("aarTime").value}
Received: ${$("aarRecv").value} klbs
 
Destination: ${d}
Alternate: ${alt}
Diversion: ${$("divFuel").value}
 
Trip fuel (computed): ${$("tripFuelOut").textContent}
  Cruise: ${$("cruiseFuelOut").textContent}
  Orbit (12/hr): ${$("orbitFuelOut").textContent}
  Transition (15/hr): ${$("transFuelOut").textContent}
  AAR (16/hr): ${$("aarFuelOut").textContent}
  Trip cont 5%: ${$("tripContOut").textContent}
  Orbit cont 3%: ${$("orbitContOut").textContent}
  Received: ${$("recvOut").textContent}
 
Required ramp fuel: ${$("reqRampOut").textContent}
Max flight time: ${$("maxTimeOut").textContent}
 
for reference only`;
 
    try {
      await navigator.clipboard.writeText(text);
      $("copyFuelBtn").textContent = "Copied ✓";
      setTimeout(()=> $("copyFuelBtn").textContent = "Copy fuel summary", 1200);
    } catch (e) {
      alert("Clipboard not allowed.\n\n" + text);
    }
  }
 
  function resetFuel(){
    $("fuelMode").value = "time";
    $("totalTime").value = "01:30";
    $("rampFuelIn").value = "";
    $("orbitTime").value = "00:00";
    $("transTime").value = "00:00";
    $("aarTime").value = "00:00";
    $("aarRecv").value = "0.0";
    $("tripContOn").checked = false;
    $("orbitContOn").checked = false;
 
    $("dest").value = Object.keys(TABLES)[0];
    populateAlt();
    $("alt").value = "0";
    setDivFields();
    calcFuel();
  }
 
  populateDest();
  populateAlt();
  setDivFields();
 
  $("dest").addEventListener("change", ()=>{ populateAlt(); $("alt").value="0"; setDivFields(); calcFuel(); });
  $("alt").addEventListener("change", ()=>{ setDivFields(); calcFuel(); });
 
  ["fuelMode","totalTime","rampFuelIn","orbitTime","transTime","aarTime","aarRecv"].forEach(id=>{
    $(id).addEventListener("input", calcFuel);
    $(id).addEventListener("change", calcFuel);
  });
  ["tripContOn","orbitContOn"].forEach(id => $(id).addEventListener("change", calcFuel));
 
  $("copyFuelBtn").addEventListener("click", copyFuel);
  $("resetFuelBtn").addEventListener("click", resetFuel);
 
 
 
  // =========================
  // WIND (fixed)
  // =========================
  function norm360(x){
    let a = Number(x);
    if (!isFinite(a)) return NaN;
    a = a % 360;
    if (a < 0) a += 360;
    return a;
  }
  function norm180(a){
    let x = ((a + 180) % 360) - 180;
    if (x < -180) x += 360;
    return x;
  }
  function parseRunwayHeading(rwyText){
    const m = String(rwyText || "").trim().match(/(\d{1,2})/);
    if (!m) return NaN;
    const n = Number(m[1]);
    if (!isFinite(n) || n < 1 || n > 36) return NaN;
    return (n === 36) ? 360 : n * 10;
  }
  function fmtDirSpd(dir, spd){
    const d = Math.round(norm360(dir));
    const s = Math.round(spd);
    return `${String(d).padStart(3,"0")}/${s} kt`;
  }
 
  function windLimits(op, firstPilot){
    let xw = 25;
    if (op === "TNG_DRY") xw = 15;
    if (op === "TNG_WET") xw = 10;
    if (op === "LANDING" && firstPilot) xw = Math.min(xw, 15);
    return { xwLim: xw, twLim: 10, maxLim: 50 };
  }
 
  function componentsFor(speed, windDir, rwyHdg){
    const w = norm360(windDir);
    const r = norm360(rwyHdg === 360 ? 0 : rwyHdg);
    const signedDelta = norm180(w - r);
    const absDelta = Math.abs(signedDelta);
    const rad = absDelta * Math.PI / 180;
 
    const htMag = speed * Math.abs(Math.cos(rad));
    const crossMag = speed * Math.sin(rad);
 
    const isHead = absDelta <= 90;
    const ht = isHead ? htMag : -htMag;
 
    const xwSigned = (signedDelta >= 0 ? crossMag : -crossMag);
    return { signedDelta, absDelta, ht, xwAbs: Math.abs(xwSigned), xwSide: (xwSigned >= 0 ? "R" : "L") };
  }
 
  function violations(speed, comp, lim){
    const tail = comp.ht < 0 ? -comp.ht : 0;
    const vXW = comp.xwAbs > lim.xwLim + 1e-9;
    const vTW = tail > lim.twLim + 1e-9;
    const vMax = speed > lim.maxLim + 1e-9;
    const ok = !(vXW || vTW || vMax);
    const margins = [lim.maxLim - speed, lim.xwLim - comp.xwAbs];
    if (comp.ht < 0) margins.push(lim.twLim - tail);
    return { ok, tail, vXW, vTW, vMax, minMargin: Math.min(...margins) };
  }
 
  function maxAllowedSpeedSameAngle(comp, lim){
    const rad = comp.absDelta * Math.PI/180;
    const sinv = Math.sin(rad);
    const cosAbs = Math.abs(Math.cos(rad));
 
    let vmax = lim.maxLim;
    if (sinv > 1e-9) vmax = Math.min(vmax, lim.xwLim / sinv);
    if (comp.absDelta > 90 && cosAbs > 1e-9) vmax = Math.min(vmax, lim.twLim / cosAbs);
    return vmax;
  }
 
  function nearestDeltaAtSameSpeed(speed, currentAbsDelta, lim, wantInLimits){
    let best = null, bestDiff = Infinity;
    for (let d = 0; d <= 180; d += 0.1) {
      const rad = d * Math.PI/180;
      const xw = speed * Math.sin(rad);
      const tail = (d > 90) ? speed * (-Math.cos(rad)) : 0;
 
      const vXW = xw > lim.xwLim + 1e-9;
      const vMax = speed > lim.maxLim + 1e-9;
      const vTW = tail > lim.twLim + 1e-9;
      const isIn = !(vXW || vTW || vMax);
 
      if (wantInLimits ? isIn : !isIn) {
        const diff = Math.abs(d - currentAbsDelta);
        if (diff < bestDiff) { bestDiff = diff; best = d; }
      }
    }
    return best;
  }
 
  function calcWind(){
    const rwy = parseRunwayHeading($("rwy").value);
    const op = $("op").value;
    const firstPilot = $("firstPilot").checked;
 
    const wdir = norm360($("windDir").value);
    const wspd = Number($("windSpd").value);
    const gustIn = $("windGust").value.trim();
    const gust = gustIn === "" ? NaN : Number(gustIn);
 
    if (!isFinite(rwy) || !isFinite(wdir) || !isFinite(wspd) || wspd < 0) {
      setText("windStatus","—");
      ["rwyHdgOut","deltaOut","htOut","xwOut","limitsOut","marginWindOut","qrA_lbl","qrA","qrB_lbl","qrB"].forEach(id=>setText(id,"—"));
      return;
    }
 
    const lim = windLimits(op, firstPilot);
 
    const compS = componentsFor(wspd, wdir, rwy);
    const vioS = violations(wspd, compS, lim);
 
    const hasGust = isFinite(gust) && gust >= 0;
    const gustSpd = hasGust ? gust : NaN;
    const compG = hasGust ? componentsFor(gustSpd, wdir, rwy) : null;
    const vioG = hasGust ? violations(gustSpd, compG, lim) : null;
 
    const okAll = vioS.ok && (!hasGust || vioG.ok);
 
    const steadyCaution = vioS.minMargin >= 0 && vioS.minMargin < 5;
    const gustCaution = hasGust ? (vioG.minMargin >= 0 && vioG.minMargin < 5) : false;
 
    let statusTxt = "OK", statusClass = "ok";
    if (!okAll) { statusTxt = "NO-GO"; statusClass = "bad"; }
    else if (steadyCaution || gustCaution) { statusTxt = "CAUTION"; statusClass = "warn"; }
 
    setHTML("windStatus", `<span class="${statusClass}">${statusTxt}</span>`);
 
    setText("rwyHdgOut", (rwy === 360 ? "360°" : `${String(rwy).padStart(3,"0")}°`));
    setText("deltaOut", `${compS.absDelta.toFixed(0)}°`);
 
    // Per-row coloring rules:
    // - Base value red if that row's *steady* limit is exceeded (plus max-wind where relevant).
    // - Gust value red only if gust violates that row's limit (plus max-wind where relevant).
    // - If BOTH steady and gust are out of limits, whole row red anyway (via base red + gust red).
    const htBaseBad = (vioS.vTW || vioS.vMax);
    const xwBaseBad = (vioS.vXW || vioS.vMax);
 
    const htLabelS = compS.ht >= 0 ? `HW ${Math.abs(compS.ht).toFixed(1)} kt` : `TW ${Math.abs(compS.ht).toFixed(1)} kt`;
    let htG_html = "";
    if (hasGust){
      const htLabelG = `Gust ${Math.abs(compG.ht).toFixed(1)} kt`;
      const htG_bad = (vioG.vTW || vioG.vMax);  // do NOT mark red just because crosswind is exceeded
      htG_html = ` • <span class="${htG_bad ? "bad" : ""}">${htLabelG}</span>`;
    }
    setHTML("htOut", `<span class="${htBaseBad ? "bad" : ""}">${htLabelS}</span>${htG_html}`);
 
    const xwLabelS = `XW ${compS.xwAbs.toFixed(1)} kt (${compS.xwSide})`;
    let xwG_html = "";
    if (hasGust){
      const xwLabelG = `Gust ${compG.xwAbs.toFixed(1)} kt`;
      const xwG_bad = (vioG.vXW || vioG.vMax);
      xwG_html = ` • <span class="${xwG_bad ? "bad" : ""}">${xwLabelG}</span>`;
    }
    setHTML("xwOut", `<span class="${xwBaseBad ? "bad" : ""}">${xwLabelS}</span>${xwG_html}`);
 
    const opLabel = (op==="TNG_DRY"?"TNG Dry":op==="TNG_WET"?"TNG Wet":op==="LANDING"?"Landing":"Takeoff");
    setText("limitsOut", `XW ≤ ${lim.xwLim} | TW ≤ ${lim.twLim} | Max ≤ ${lim.maxLim} (${opLabel})`);
 
    function nearestLabel(vio, speed, comp){
      const parts = [];
      parts.push({k:"Max wind", v: lim.maxLim - speed});
      parts.push({k:"Crosswind", v: lim.xwLim - comp.xwAbs});
      if (comp.ht < 0) parts.push({k:"Tailwind", v: lim.twLim - vio.tail});
      parts.sort((a,b)=>a.v-b.v);
      return parts[0];
    }
    const nearS = nearestLabel(vioS, wspd, compS);
    let marginHtml = `${nearS.k}: ${nearS.v.toFixed(1)} kt`;
    if (nearS.v < 0) marginHtml = `<span class="bad">${marginHtml}</span>`;
    else if (nearS.v < 5) marginHtml = `<span class="warn">${marginHtml}</span>`;
    if (hasGust){
      const nearG = nearestLabel(vioG, gustSpd, compG);
      let g = `${nearG.k} (Gust): ${nearG.v.toFixed(1)} kt`;
      if (nearG.v < 0) g = `<span class="bad">${g}</span>`;
      else if (nearG.v < 5) g = `<span class="warn">${g}</span>`;
      marginHtml += `<br>${g}`;
    }
    setHTML("marginWindOut", marginHtml);
 
    // Quick reference is ALWAYS steady-only
    const vAllowSameAngle = maxAllowedSpeedSameAngle(compS, lim);
 
    if (!vioS.ok){
      $("qrA_lbl").textContent = "Just in limits (same angle):";
      $("qrB_lbl").textContent = "Just in limits (same speed):";
 
      const vIn = Math.max(0, Math.floor(vAllowSameAngle));
      setText("qrA", fmtDirSpd(wdir, vIn));
 
      const targetAbs = nearestDeltaAtSameSpeed(wspd, compS.absDelta, lim, true);
      const sign = (compS.signedDelta >= 0) ? +1 : -1;
      const newDir = (targetAbs == null) ? NaN : norm360((rwy === 360 ? 0 : rwy) + sign * targetAbs);
      setText("qrB", (isFinite(newDir) ? fmtDirSpd(newDir, wspd) : "—"));
    } else {
      $("qrA_lbl").textContent = "Just out of limits (same angle):";
      $("qrB_lbl").textContent = "Just out of limits (same speed):";
 
      // Fix: smallest integer speed that is OUT of limits (at same angle) is floor(vAllow)+1
      const vOut = Math.max(0, Math.floor(vAllowSameAngle) + 1);
      setText("qrA", fmtDirSpd(wdir, vOut));
 
      const targetAbsOut = nearestDeltaAtSameSpeed(wspd, compS.absDelta, lim, false);
      const sign = (compS.signedDelta >= 0) ? +1 : -1;
      const newDir = (targetAbsOut == null) ? NaN : norm360((rwy === 360 ? 0 : rwy) + sign * targetAbsOut);
      setText("qrB", (isFinite(newDir) ? fmtDirSpd(newDir, wspd) : "—"));
    }
  }
 
  async function copyWind(){
    const rwy = parseRunwayHeading($("rwy").value);
    const op = $("op").selectedOptions[0].textContent;
    const fp = $("firstPilot").checked ? "Yes" : "No";
 
    const wdir = norm360($("windDir").value);
    const wspd = Number($("windSpd").value);
    const gustIn = $("windGust").value.trim();
 
    const text =
`E-3A Wind
RWY: ${$("rwy").value} (${isFinite(rwy)?String(rwy).padStart(3,"0")+"°":"—"})
Operation: ${op}
First pilot: ${fp}
 
Wind: ${fmtDirSpd(wdir, wspd)}${gustIn!=="" ? " G"+Math.round(Number(gustIn)) : ""}
 
Result: ${$("windStatus").textContent}
Head/Tail: ${$("htOut").textContent}
Crosswind: ${$("xwOut").textContent}
Limits: ${$("limitsOut").textContent}
 
for reference only`;
 
    try{
      await navigator.clipboard.writeText(text);
      $("copyWindBtn").textContent = "Copied ✓";
      setTimeout(()=> $("copyWindBtn").textContent = "Copy wind summary", 1200);
    }catch(e){
      alert("Clipboard not allowed.\n\n" + text);
    }
  }
 
  function resetWind(){
    $("rwy").value = "27";
    $("op").value = "LANDING";
    $("firstPilot").checked = false;
    $("windDir").value = "270";
    $("windSpd").value = "15";
    $("windGust").value = "";
    calcWind();
  }
 
  ["rwy","op","firstPilot","windDir","windSpd","windGust"].forEach(id=>{
    $(id).addEventListener("input", calcWind);
    $(id).addEventListener("change", calcWind);
  });
  $("copyWindBtn").addEventListener("click", copyWind);
  $("resetWindBtn").addEventListener("click", resetWind);
 

  // =========================
  // MSN PLANNING
  // =========================
  function pad2(n){ return String(n).padStart(2,"0"); }
  function normalizeHHMMInput(el){
    let v = (el.value || "").trim();
    v = v.replace(".",":").replace(" ", "");
    const m4 = v.match(/^(\d{2})(\d{2})$/);
    if (m4) v = `${m4[1]}:${m4[2]}`;
    const m = v.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/);
    if (!m) return;
    let hh = Math.min(23, Math.max(0, parseInt(m[1],10)||0));
    let mm = Math.min(59, Math.max(0, parseInt(m[2],10)||0));
    el.value = `${pad2(hh)}:${pad2(mm)}`;
  }
  function zuluMinutes(hhmm){
    const t = String(hhmm||"").trim();
    const m = t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/);
    if(!m) return NaN;
    const hh=Number(m[1]), mm=Number(m[2]);
    if(!isFinite(hh)||!isFinite(mm)||hh<0||hh>23||mm<0||mm>59) return NaN;
    return hh*60+mm;
  }
  function minutesToHHMM(mins){
    if(!isFinite(mins)) return "";
    mins = ((mins%1440)+1440)%1440;
    const hh=Math.floor(mins/60), mm=mins%60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }
  function zuluToLocalStr(hhmm){
    const mins = zuluMinutes(hhmm);
    if(!isFinite(mins)) return "—";
    const now = new Date();
    const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
    d.setUTCMinutes(mins);
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }

  function updateCallsign(){ /* editable callsign, no auto-format */ }

  function populateMsnAlternate(){
    const sel = $("msn_altSel");
    if(!sel) return;
    const set = new Set();
    Object.keys(TABLES).forEach(k=>{
      (TABLES[k]||[]).forEach(r=>{ if(r && r.alt) set.add(r.alt); });
    });
    const all = Array.from(set).sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = "";
    all.forEach(name=>{
      const o=document.createElement("option");
      o.value=name; o.textContent=name;
      sel.appendChild(o);
    });
    const other=document.createElement("option");
    other.value="__OTHER__"; other.textContent="Other";
    sel.appendChild(other);
  }
  function msnAltChanged(){
    const isOther = $("msn_altSel").value === "__OTHER__";
    $("msn_altOtherWrap").classList.toggle("hidden", !isOther);
  }

  const MSN_OFFSETS_MIN = { bus1:-120, bus2:-70, b4:-60, door:-35, eng:-30 };
  const msnEdited = {};
  function markEdited(id){ msnEdited[id]=true; }
  function setIfNotEdited(id, value){
    const el = $(id);
    if(!el) return;
    if (!msnEdited[id]) el.value = value;
  }

  function updateTimeline(){
    const toEl = $("msn_z_to");
    if(!toEl) return;
    ["msn_z_show","msn_z_bus1","msn_z_bus2","msn_z_b4","msn_z_door","msn_z_eng","msn_z_to"].forEach(id=>{
      const el=$(id); if(el) normalizeHHMMInput(el);
    });

    const toMin = zuluMinutes(toEl.value);
    if(!isFinite(toMin)){
      ["show","bus1","bus2","b4","door","eng","to"].forEach(k=>{
        const loc=$("msn_loc_"+k);
        if(loc) loc.textContent="—";
      });
      return;
    }

    const de = $("msn_deice")?.checked ? -30 : 0;

    // Base offsets (minutes before TAKEOFF)
    const OFF = { show:-150, bus1:-120, bus2:-70, b4:-60, door:-35, eng:-30 };

    // Apply DE-ICE shift to ALL events except TAKEOFF
    setIfNotEdited("msn_z_show", minutesToHHMM(toMin + OFF.show + de));
    setIfNotEdited("msn_z_bus1", minutesToHHMM(toMin + OFF.bus1 + de));
    setIfNotEdited("msn_z_bus2", minutesToHHMM(toMin + OFF.bus2 + de));
    setIfNotEdited("msn_z_b4",   minutesToHHMM(toMin + OFF.b4  + de));
    setIfNotEdited("msn_z_door", minutesToHHMM(toMin + OFF.door+ de));
    setIfNotEdited("msn_z_eng",  minutesToHHMM(toMin + OFF.eng + de));

    $("msn_loc_show").textContent = zuluToLocalStr($("msn_z_show").value);
    $("msn_loc_bus1").textContent = zuluToLocalStr($("msn_z_bus1").value);
    $("msn_loc_bus2").textContent = zuluToLocalStr($("msn_z_bus2").value);
    $("msn_loc_b4").textContent   = zuluToLocalStr($("msn_z_b4").value);
    $("msn_loc_door").textContent = zuluToLocalStr($("msn_z_door").value);
    $("msn_loc_eng").textContent  = zuluToLocalStr($("msn_z_eng").value);
    $("msn_loc_to").textContent   = zuluToLocalStr($("msn_z_to").value);
  }

  function updateDur(){
    const toA = zuluMinutes(($("msn_a_to")?.value||"").trim());
    const landA = zuluMinutes(($("msn_a_land")?.value||"").trim());
    if(!isFinite(toA) || !isFinite(landA)){
      if($("msn_dur")) $("msn_dur").value = "";
      return;
    }
    let diff = landA - toA;
    if(diff < 0) diff += 1440;
    const hrs = diff / 60.0;
    if($("msn_dur")) {
      const v = (Math.round(hrs*100)/100).toFixed(2).replace(".", ",");
      $("msn_dur").value = v;
    }
  }

  function wireMsn(){
    if(!$("viewMsn")) return;

    if ($("msn_callsign")){
      /* no special handling */
    }

    if ($("msn_altSel")){
      populateMsnAlternate();
      $("msn_altSel").addEventListener("change", msnAltChanged);
      msnAltChanged();
    }

    ["msn_z_show","msn_z_bus1","msn_z_bus2","msn_z_b4","msn_z_door","msn_z_eng"].forEach(id=>{
      const el=$(id);
      if(!el) return;
      el.addEventListener("input", ()=>{ markEdited(id); updateTimeline(); });
      el.addEventListener("change", ()=>{ markEdited(id); updateTimeline(); });
    });

    if ($("msn_z_to")){
      $("msn_z_to").addEventListener("change", updateTimeline);
    }
    if ($("msn_deice")){
      $("msn_deice").addEventListener("change", ()=>{
        if(!msnEdited["msn_z_show"] && $("msn_z_show")) $("msn_z_show").value = "";
        updateTimeline();
      });
    }

    document.querySelectorAll("#viewMsn .timeZ").forEach(el=>{
      el.addEventListener("blur", ()=>{ normalizeHHMMInput(el); updateTimeline(); updateDur(); });
    });

    ["msn_a_to","msn_a_land"].forEach(id=>{
      const el=$(id);
      if(!el) return;
      el.addEventListener("input", updateDur);
      el.addEventListener("change", updateDur);
    });

    updateTimeline();
    updateDur();
  }

  // =========================
  // QUICK REFERENCE SETTINGS (local only)
  // =========================
  const QR_KEY_ORDERS = "qr_email_orders";
  const QR_KEY_ORM    = "qr_email_orm";

  function loadQuickRef(){
    const orders = localStorage.getItem(QR_KEY_ORDERS) || $("qr_email_orders")?.value || "";
    const orm    = localStorage.getItem(QR_KEY_ORM)    || $("qr_email_orm")?.value || "";
    if ($("qr_email_orders")) $("qr_email_orders").value = orders;
    if ($("qr_email_orm")) $("qr_email_orm").value = orm;
    if ($("qr_set_orders")) $("qr_set_orders").value = orders;
    if ($("qr_set_orm")) $("qr_set_orm").value = orm;
  }

  function openQrSettings(){
    loadQuickRef();
    $("qrSettingsModal")?.classList.remove("hidden");
  }
  function closeQrSettings(){
    $("qrSettingsModal")?.classList.add("hidden");
  }
  function saveQrSettings(){
    const orders = ($("qr_set_orders")?.value || "").trim();
    const orm    = ($("qr_set_orm")?.value || "").trim();
    localStorage.setItem(QR_KEY_ORDERS, orders);
    localStorage.setItem(QR_KEY_ORM, orm);
    loadQuickRef();
    closeQrSettings();
  }
  function clearQrSettings(){
    localStorage.removeItem(QR_KEY_ORDERS);
    localStorage.removeItem(QR_KEY_ORM);
    if ($("qr_set_orders")) $("qr_set_orders").value = "";
    if ($("qr_set_orm")) $("qr_set_orm").value = "";
    loadQuickRef();
    closeQrSettings();
  }

  // Robust modal controls (event delegation)
  document.addEventListener("click", (ev) => {
    const t = ev.target;
    if (t.closest && t.closest("#qrSettingsBtn")) { ev.preventDefault(); openQrSettings(); return; }
    if (t.closest && t.closest("#qrSettingsClose")) { ev.preventDefault(); closeQrSettings(); return; }
    if (t.closest && t.closest("#qrSettingsBackdrop")) { ev.preventDefault(); closeQrSettings(); return; }
    if (t.closest && t.closest("#qrSettingsSave")) { ev.preventDefault(); saveQrSettings(); return; }
    if (t.closest && t.closest("#qrSettingsClear")) { ev.preventDefault(); clearQrSettings(); return; }
  });

  // ESC closes (if keyboard available)
  document.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape") closeQrSettings();
  });
// INIT
  applySavedInputs();
  renderChecklist();
  renderSeat();

  wireAutoSave([
    // Fuel
    "fuelMode","totalTime","rampFuelIn","dest","alt","orbitTime","transTime","aarTime","aarRecv","tripContOn","orbitContOn",
    // Wind
    "rwyHdg","windDir","windSpd","windGust","maxTail","maxXwind",
    // MSN Planning
    "msn_msn","msn_callsign","msn_tail","msn_pob","msn_orbit","msn_parking","msn_status","msn_spare","msn_alternate",
    "msn_show","msn_bus1","msn_bus2","msn_b4start","msn_doorclose","msn_engstart","msn_deice","msn_takeoff","msn_to","msn_land","msn_ons","msn_offs","msn_arstart","msn_arend","msn_txstart","msn_txend",
    "msn_orders_email","msn_orm_email"
  ]);

  $("resetMsnBtn")?.addEventListener("click", resetMsn);
  $("resetChecklistBtn")?.addEventListener("click", resetChecklist);
  $("resetSeatBtn")?.addEventListener("click", resetSeat);
  $("addSeatRowBtn")?.addEventListener("click", (e) => {
    e.preventDefault();
    const body = $("seatTableBody");
    if (!body) return;
    body.appendChild(seatRowEl({ phase:"", left:"", right:"", seat5:"", time:"" }));
    persistSeat();
  });

  calcFuel();
  calcWind();
  wireMsn();
    loadQuickRef();
    $("qrSettingsBtn")?.addEventListener("click", openQrSettings);
    $("qrSettingsClose")?.addEventListener("click", closeQrSettings);
    $("qrSettingsBackdrop")?.addEventListener("click", closeQrSettings);
    $("qrSettingsSave")?.addEventListener("click", saveQrSettings);
    $("qrSettingsClear")?.addEventListener("click", clearQrSettings);
    $("msnExport")?.addEventListener("click", exportMsnState);
    $("msnReset")?.addEventListener("click", resetMsnState);
    setTab("fuel");
})();
</script>
<script>
  // PWA offline support
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
</script>
  <script>
  // Launchscreen: run once per app start (you can switch to session-only if you want)
  window.addEventListener("load", () => {
    const el = document.getElementById("launch");
    if (!el) return;
 
    // Optional: only once per session
    // if (sessionStorage.getItem("launchDone") === "1") { el.remove(); return; }
    // sessionStorage.setItem("launchDone","1");
 
    // Remove after animation
    setTimeout(() => {
  const BUILD_VERSION = "2026-02-17 12:20:35 UTC (4634)";
      el.style.transition = "opacity .25s ease";
      el.style.opacity = "0";
      setTimeout(() => el.remove(), 260);
    }, 1900);
  });
</script>
 
 
      </div>
    </div>
 
    </div>
  </div>
</div>
 

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const v = document.createElement("div");
    v.style.textAlign = "center";
    v.style.fontSize = "11px";
    v.style.opacity = "0.6";
    v.style.marginTop = "4px";
    v.textContent = "Build: 2026-02-18 06:57:59 UTC (8ee3)";
    document.body.appendChild(v);
  });
</script>


<div id="qrSettingsModal" class="modal hidden">
  <div class="modalBackdrop" id="qrSettingsBackdrop"></div>
  <div class="modalSheet" id="qrSettingsSheet">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div style="font-weight:900;">Quick Reference Settings</div>
      <button id="qrSettingsClose" type="button" class="iconBtn" aria-label="Close">✕</button>
    </div>

    <div style="margin-top:12px;">
      <label>Orders / CMD Post</label>
      <input id="qr_set_orders" type="email" autocomplete="off" spellcheck="false" placeholder="name@naew.nato.int">
    </div>

    <div style="margin-top:12px;">
      <label>ORM / Safety</label>
      <input id="qr_set_orm" type="email" autocomplete="off" spellcheck="false" placeholder="name@naew.nato.int">
    </div>

    <div class="row" style="margin-top:14px;">
      <button id="qrSettingsSave" type="button" class="btnSmall">Save</button>
      <button id="qrSettingsClear" type="button" class="btnSmall danger">Clear</button>
    </div>
  </div>
</div>

</body>
</html>
